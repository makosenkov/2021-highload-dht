## Нагрузочное тестирование вставки (PUT)
**Скрипт для тестирования put.lua:**
```
 counter = 0
 
 request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "PUT"
    wrk.body = "<строка для вставки>" .. counter
    counter = counter + 1
    return wrk.format(nil, path)
end
```
**Лог утилиты wrk:**
```
(base) mksnkv@mksnkv-TM1604:~/Documents/wrktest$ wrk -c 1 -t 1 -d 2m -R 1000 -L -s put.lua http://localhost:8080  
Running 2m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 7.505ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.83ms   19.33ms 317.95ms   98.90%
    Req/Sec     1.05k   467.79    26.20k    98.47%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.97ms
 75.000%    1.28ms
 90.000%    1.57ms
 99.000%   47.39ms
 99.900%  284.16ms
 99.990%  311.55ms
 99.999%  317.44ms
100.000%  318.21ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.044     0.000000            1         1.00
       0.435     0.100000        11018         1.11
       0.585     0.200000        22016         1.25
       0.721     0.300000        33087         1.43
       0.847     0.400000        44022         1.67
       0.971     0.500000        55030         2.00
       1.033     0.550000        60523         2.22
       1.094     0.600000        65999         2.50
       1.155     0.650000        71585         2.86
       1.215     0.700000        77040         3.33
       1.284     0.750000        82546         4.00
       1.318     0.775000        85249         4.44
       1.354     0.800000        88036         5.00
       1.392     0.825000        90775         5.71
       1.439     0.850000        93523         6.67
       1.496     0.875000        96248         8.00
       1.530     0.887500        97630         8.89
       1.568     0.900000        98998        10.00
       1.612     0.912500       100397        11.43
       1.664     0.925000       101766        13.33
       1.728     0.937500       103142        16.00
       1.765     0.943750       103822        17.78
       1.809     0.950000       104504        20.00
       1.866     0.956250       105188        22.86
       1.950     0.962500       105874        26.67
       2.077     0.968750       106570        32.00
       2.163     0.971875       106907        35.56
       2.317     0.975000       107246        40.00
       2.523     0.978125       107589        45.71
       2.989     0.981250       107934        53.33
       3.881     0.984375       108278        64.00
       4.635     0.985938       108449        71.11
       5.807     0.987500       108621        80.00
      23.071     0.989062       108792        91.43
      64.351     0.990625       108964       106.67
     105.343     0.992188       109136       128.00
     125.759     0.992969       109222       142.22
     146.431     0.993750       109308       160.00
     166.783     0.994531       109394       182.86
     187.519     0.995313       109480       213.33
     207.999     0.996094       109567       256.00
     217.983     0.996484       109609       284.44
     228.351     0.996875       109652       320.00
     238.719     0.997266       109696       365.71
     248.959     0.997656       109738       426.67
     259.455     0.998047       109782       512.00
     264.447     0.998242       109804       568.89
     269.311     0.998437       109824       640.00
     274.943     0.998633       109848       731.43
     279.807     0.998828       109868       853.33
     284.671     0.999023       109889      1024.00
     287.487     0.999121       109900      1137.78
     290.047     0.999219       109910      1280.00
     292.351     0.999316       109920      1462.86
     295.167     0.999414       109931      1706.67
     297.727     0.999512       109942      2048.00
     299.007     0.999561       109947      2275.56
     300.287     0.999609       109953      2560.00
     301.823     0.999658       109958      2925.71
     303.359     0.999707       109963      3413.33
     305.407     0.999756       109969      4096.00
     305.919     0.999780       109971      4551.11
     307.199     0.999805       109974      5120.00
     308.735     0.999829       109977      5851.43
     309.759     0.999854       109980      6826.67
     310.783     0.999878       109982      8192.00
     311.551     0.999890       109984      9102.22
     312.575     0.999902       109986     10240.00
     312.575     0.999915       109986     11702.86
     313.343     0.999927       109987     13653.33
     314.367     0.999939       109990     16384.00
     314.367     0.999945       109990     18204.44
     314.367     0.999951       109990     20480.00
     315.135     0.999957       109991     23405.71
     315.135     0.999963       109991     27306.67
     315.391     0.999969       109992     32768.00
     315.391     0.999973       109992     36408.89
     316.415     0.999976       109993     40960.00
     316.415     0.999979       109993     46811.43
     316.415     0.999982       109993     54613.33
     317.439     0.999985       109994     65536.00
     317.439     0.999986       109994     72817.78
     317.439     0.999988       109994     81920.00
     317.439     0.999989       109994     93622.86
     317.439     0.999991       109994    109226.67
     318.207     0.999992       109995    131072.00
     318.207     1.000000       109995          inf
#[Mean    =        2.826, StdDeviation   =       19.325]
#[Max     =      317.952, Total count    =       109995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  120000 requests in 2.00m, 7.67MB read
Requests/sec:   1000.00
Transfer/sec:     65.43KB
```
Заметно, что в какой-то момент время ответа сильно увеличивается (с ~1,5мс до ~300мс). Это можно объяснить реализацией
DAO, которая до определенного момента записывает данные в оперативную память, и только при достижении указанного размера
хранилища записывает на диск. В этом можно удостовериться, посмотрев отчеты о профилировании:  

**Профилирование во время записи в ОП:**[put_test_ram.html](put_test_ram.html)  
**Профилирование во время записи на диск:**[put_test.html](put_test.html)
Видно, что во втором отчете выполняются системные вызовы для записи на диск.  

Также время ответа, естественно, зависит от скорости физического накопителя. По опросу некоторых коллег с более
медленными дисками, при тех же условиях записи время ответа могло увеличиваться до нескольких раз.  

Кроме этого, узким местом является то, что ответ сервера приходит только после работы вызовов записи. В приведенных
отчетах о профилировании видно, что запись практически равняется времени формирования ответа. И это с учетом того, что
использовалась не очень длинная строка для вставки. Если увеличить объем единовременно записываемой информации, время 
ответа будет сильно увеличено. Для решения данной проблемы необходимо разделить выполнение запросов на несколько 
потоков.

**Профилирование памяти**:[put_alloc_test.html](put_alloc_test.html)
По отчету о профилировании выделения памяти видно, что one-nio тратит достаточно много памяти на разбор запроса и
перекодирование строк.
##Нагрузочное тестирование получения (GET)
**Скрипт для тестирования get.lua:**
```
 counter = 0
 
 request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "GET"
    counter = counter + 1
    return wrk.format(nil, path)
end

```
Консольный лог работы wrk:
```
(base) mksnkv@mksnkv-TM1604:~/Documents/wrktest$ wrk -c 1 -t 1 -d 60s -R 1000 -L -s get.lua http://localhost:8080 
Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.376ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.15ms  617.36us  11.71ms   82.26%
    Req/Sec     1.05k    94.39     1.78k    87.13%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.10ms
 75.000%    1.42ms
 90.000%    1.70ms
 99.000%    3.27ms
 99.900%    7.10ms
 99.990%   10.79ms
 99.999%   11.72ms
100.000%   11.72ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.060     0.000000            1         1.00
       0.539     0.100000         5021         1.11
       0.699     0.200000        10000         1.25
       0.841     0.300000        15002         1.43
       0.972     0.400000        20039         1.67
       1.100     0.500000        25022         2.00
       1.162     0.550000        27508         2.22
       1.222     0.600000        29998         2.50
       1.288     0.650000        32525         2.86
       1.352     0.700000        35007         3.33
       1.422     0.750000        37510         4.00
       1.460     0.775000        38763         4.44
       1.499     0.800000        39999         5.00
       1.542     0.825000        41269         5.71
       1.586     0.850000        42516         6.67
       1.640     0.875000        43760         8.00
       1.667     0.887500        44373         8.89
       1.703     0.900000        44998        10.00
       1.745     0.912500        45624        11.43
       1.791     0.925000        46249        13.33
       1.853     0.937500        46882        16.00
       1.885     0.943750        47189        17.78
       1.930     0.950000        47501        20.00
       1.978     0.956250        47817        22.86
       2.034     0.962500        48125        26.67
       2.101     0.968750        48438        32.00
       2.151     0.971875        48591        35.56
       2.217     0.975000        48746        40.00
       2.299     0.978125        48903        45.71
       2.415     0.981250        49058        53.33
       2.585     0.984375        49217        64.00
       2.711     0.985938        49292        71.11
       2.873     0.987500        49371        80.00
       3.079     0.989062        49449        91.43
       3.409     0.990625        49528       106.67
       3.769     0.992188        49605       128.00
       3.971     0.992969        49644       142.22
       4.215     0.993750        49683       160.00
       4.447     0.994531        49723       182.86
       4.695     0.995313        49761       213.33
       5.035     0.996094        49800       256.00
       5.163     0.996484        49822       284.44
       5.307     0.996875        49839       320.00
       5.559     0.997266        49860       365.71
       5.783     0.997656        49878       426.67
       6.103     0.998047        49899       512.00
       6.351     0.998242        49908       568.89
       6.511     0.998437        49917       640.00
       6.755     0.998633        49927       731.43
       6.991     0.998828        49938       853.33
       7.123     0.999023        49947      1024.00
       7.451     0.999121        49952      1137.78
       7.575     0.999219        49956      1280.00
       7.687     0.999316        49961      1462.86
       7.815     0.999414        49966      1706.67
       8.031     0.999512        49971      2048.00
       8.091     0.999561        49974      2275.56
       8.431     0.999609        49976      2560.00
       8.495     0.999658        49978      2925.71
       8.919     0.999707        49982      3413.33
       9.015     0.999756        49983      4096.00
       9.535     0.999780        49985      4551.11
       9.575     0.999805        49986      5120.00
       9.967     0.999829        49987      5851.43
      10.215     0.999854        49988      6826.67
      10.423     0.999878        49989      8192.00
      10.791     0.999890        49990      9102.22
      10.855     0.999902        49991     10240.00
      10.855     0.999915        49991     11702.86
      11.167     0.999927        49992     13653.33
      11.167     0.999939        49992     16384.00
      11.343     0.999945        49993     18204.44
      11.343     0.999951        49993     20480.00
      11.343     0.999957        49993     23405.71
      11.415     0.999963        49994     27306.67
      11.415     0.999969        49994     32768.00
      11.415     0.999973        49994     36408.89
      11.415     0.999976        49994     40960.00
      11.415     0.999979        49994     46811.43
      11.719     0.999982        49995     54613.33
      11.719     1.000000        49995          inf
#[Mean    =        1.151, StdDeviation   =        0.617]
#[Max     =       11.712, Total count    =        49995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  60000 requests in 1.00m, 12.35MB read
Requests/sec:    999.98
Transfer/sec:    210.75KB

```

Отчеты профилирования:
**Процессор:**[get_test.html](get_test.html)
**Память:**[get_alloc_test.html](get_alloc_test.html)

По отчету заметно, что 99,9% запросов отработали быстрее, чем за 10 мс, более редкие запросы заняли больше 10 мс.
Если увеличить количество запросов в секунду, можно увидеть, что данные показатели ухудшатся из-за накапливающейся 
очереди запросов.

Например, при 5000 запросах в секунду в течение 10 секунд:
```
 50.000%    1.61ms
 75.000%   13.71ms
 90.000%   30.86ms
 99.000%   47.33ms
 99.900%   51.81ms
 99.990%   53.76ms
 99.999%   53.92ms
100.000%   53.92ms
```
Еще хуже статистика при более длительной нагрузке, что свидетельствует о накоплении очереди и соответственно
серьезном увеличении времени ответа
Например, 60 секунд при 5000 запросах/сек:
```
 50.000%    1.59ms
 75.000%    9.83ms
 90.000%   40.26ms
 99.000%  263.42ms
 99.900%  326.65ms
 99.990%  329.47ms
 99.999%  329.98ms
100.000%  330.24ms
```
Эти результаты говорят об узком месте в виде одного соединения, а также однопоточной записи,
из-за которых приходящие запросы не могут быть обработаны асинхронно, вследствие чего копятся.

##Выводы:
+ Необходимо обеспечить поддержку нескольких соединений  
+ Необходимо обеспечить возможность параллельного выполнения операций чтения и вставки
+ Необходимо учитывать физические параметры диска